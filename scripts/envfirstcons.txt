DECLARE    
 Cursor c_config_mvintegra IS
  SELECT cd_nota_fiscal,cd_multi_empresa  FROM dbamv.mvs_nota_fiscal mvs wheRE mvs.nr_nota_fiscal_nfe IS NULL AND 
  Trunc(mvs.DT_EMISSAO) >= To_Date('01062024','DDMMYYYY') AND 
  mvs.DS_retorno_nfe LIKE ('%CODIGO : E010%') AND cd_status = 'E' AND cd_status_nfe = 'T';  
 
 CURSOR c_integ(cd_nota number) is 
  SELECT * FROM mvintegra.imv_nota_fiscal_eletronica WHERE cd_nota_fiscal = cd_nota AND tp_registro = '033'
  AND tp_registro = '033' AND ROWNUM < 2;  

  v_integ c_integ%ROWTYPE;
BEGIN  
  FOR nota_i  IN c_config_mvintegra LOOP
    OPEN c_integ(nota_i.cd_nota_fiscal);
    FETCH c_integ INTO v_integ;

    IF c_integ%FOUND THEN 
      dbamv.pkg_mv2000.atribui_empresa(nota_i.cd_multi_empresa);
      
      UPDATE dbamv.mvs_nota_fiscal SET nr_protocolo = v_integ.nr_protocolo , CD_STATUS_NFE = 'T' 
        WHERE cd_nota_fiscal = nota_i.cd_nota_fiscal;
        
    END IF; 
    
    CLOSE c_integ;
    COMMIT;    
  END LOOP;         
END;
